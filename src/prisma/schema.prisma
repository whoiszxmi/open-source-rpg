datasource db {
  provider = "mysql"
}

generator client {
  provider = "prisma-client-js"
}

enum Rank {
  F
  D_MINUS
  D
  D_PLUS
  C_MINUS
  C
  C_PLUS
  B_MINUS
  B
  B_PLUS
  A_MINUS
  A
  A_PLUS
  EX
}

enum StatGroupType {
  PHYSICAL
  JUJUTSU
  MENTAL
  EXTRA
}

model Character {
  id                             Int     @id @default(autoincrement())
  name                           String
  age                            Int?
  gender                         String?
  player_name                    String?
  level                          Int     @default(1)
  xp                             Int     @default(0)
  current_hit_points             Int     @default(0)
  max_hit_points                 Int     @default(0)
  current_picture                Int     @default(1)
  is_dead                        Boolean @default(false)
  standard_character_picture_url String?
  injured_character_picture_url  String?
  appearance_key                 String?
  idle_anim_key                  String?
  attack_anim_key                String?
  hit_anim_key                   String?
  scene_key                      String?
  origin                         String? @db.VarChar(80)
  personalityTag                 String? @db.VarChar(60)
  bindingVow                     String? @db.VarChar(240)
  goal                           String? @db.VarChar(240)

  creationStep       Int      @default(0)
  isCreationComplete Boolean  @default(false)
  created_at         DateTime @default(now())

  attributes CharacterAttributes[]
  skills     CharacterSkills[]
  rolls      Roll[]

  // ============================
  // Jujutsu Edition (relações)
  // ============================

  cursedStats         CursedStats?
  innateTechniques    InnateTechnique[]
  bindingVows         BindingVow[]
  domainState         DomainState?
  combatStatuses      CombatStatus[]
  blackFlashState     BlackFlashState?
  blessings           CharacterBlessing[]
  curses              CharacterCurse[]
  statGroups          StatGroup[]
  roomParticipants    RoomParticipant[]
  characterAppearance CharacterAppearance?

  @@map("character")
}

model CharacterAttributes {
  character    Character @relation(fields: [character_id], references: [id])
  character_id Int
  attribute    Attribute @relation(fields: [attribute_id], references: [id])
  attribute_id Int

  value String?

  @@id([character_id, attribute_id])
  @@map("character_attributes")
}

model Attribute {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  characters CharacterAttributes[]

  @@map("attribute")
}

model CharacterSkills {
  character    Character @relation(fields: [character_id], references: [id])
  character_id Int
  skill        Skill     @relation(fields: [skill_id], references: [id])
  skill_id     Int

  value String?

  @@id([character_id, skill_id])
  @@map("character_skills")
}

model Skill {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  characters CharacterSkills[]

  @@map("skills")
}

model Roll {
  id Int @id @default(autoincrement())

  max_number    Int
  rolled_number Int

  character    Character @relation(fields: [character_id], references: [id])
  character_id Int

  rolled_at DateTime @default(now())

  @@map("roll")
}

model Config {
  id    Int     @id @default(autoincrement())
  name  String  @unique
  value String?

  @@map("config")
}

model StatGroup {
  id          Int           @id @default(autoincrement())
  characterId Int
  type        StatGroupType
  totalPoints Int           @default(0)
  rank        Rank          @default(F)

  character Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)
  stats     StatValue[]

  @@unique([characterId, type])
  @@index([characterId])
  @@map("stat_group")
}

model StatValue {
  id      Int    @id @default(autoincrement())
  groupId Int
  key     String
  value   Int    @default(0)

  group StatGroup @relation(fields: [groupId], references: [id])

  @@index([groupId])
  @@map("stat_value")
}

model Blessing {
  id          Int     @id @default(autoincrement())
  key         String  @unique
  name        String
  rank        Rank
  cost        Int
  category    String
  type        String?
  description String?
  effects     Json
  tags        Json?
  excludes    Json?

  characters CharacterBlessing[]

  @@map("blessing")
}

model Curse {
  id          Int     @id @default(autoincrement())
  key         String  @unique
  name        String
  rank        Rank
  reward      Int
  category    String
  type        String?
  valueGain   Int?
  description String?
  effects     Json
  tags        Json?
  excludes    Json?

  characters CharacterCurse[]

  @@map("curse")
}

model CharacterBlessing {
  id          Int      @id @default(autoincrement())
  characterId Int
  blessingId  Int
  createdAt   DateTime @default(now())

  character Character @relation(fields: [characterId], references: [id])
  blessing  Blessing  @relation(fields: [blessingId], references: [id])

  @@index([characterId])
  @@index([blessingId])
  @@map("character_blessing")
}

model CharacterCurse {
  id          Int      @id @default(autoincrement())
  characterId Int
  curseId     Int
  createdAt   DateTime @default(now())

  character Character @relation(fields: [characterId], references: [id])
  curse     Curse     @relation(fields: [curseId], references: [id])

  @@index([characterId])
  @@index([curseId])
  @@map("character_curse")
}

model BlackFlashState {
  id            Int @id @default(autoincrement())
  characterId   Int @unique
  activeTurns   Int @default(0)
  nextThreshold Int @default(20)

  character Character @relation(fields: [characterId], references: [id])

  @@map("black_flash_state")
}

// ===================================
// Jujutsu Edition (novos models)
// ===================================

model CursedStats {
  id          Int @id @default(autoincrement())
  characterId Int @unique

  cursedEnergyMax Int
  cursedEnergy    Int
  cursedControl   Int
  mentalPressure  Int
  domainUnlocked  Boolean @default(false)

  character Character @relation(fields: [characterId], references: [id])

  @@map("cursed_stats")
}

model InnateTechnique {
  id          Int @id @default(autoincrement())
  characterId Int

  name        String
  description String
  cost        Int
  effect      String

  character Character @relation(fields: [characterId], references: [id])

  @@map("innate_technique")
}

model BindingVow {
  id          Int @id @default(autoincrement())
  characterId Int

  vow     String
  bonus   String
  penalty String

  character Character @relation(fields: [characterId], references: [id])

  @@map("binding_vow")
}

model DomainState {
  id             Int     @id @default(autoincrement())
  characterId    Int     @unique
  type           String // "EXPANSION" | "SIMPLE_DOMAIN" | "WICKER_BASKET" | "AMPLIFICATION"
  turnsRemaining Int
  sureHitActive  Boolean @default(false)
  notes          String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  character Character @relation(fields: [characterId], references: [id])

  @@map("domain_state")
}

model CombatStatus {
  id             Int     @id @default(autoincrement())
  characterId    Int
  sourceId       Int? // quem aplicou (opcional)
  key            String // ex: "BURN", "BLEED", "STUN", "TECH_SEAL"
  kind           String // "BUFF" | "DEBUFF"
  value          Int     @default(0) // intensidade
  stacks         Int     @default(1)
  turnsRemaining Int     @default(1)
  note           String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  character Character @relation(fields: [characterId], references: [id])

  @@index([characterId])
  @@map("combat_status")
}

model Combat {
  id          Int      @id @default(autoincrement())
  roomId      Int?
  sceneId     Int?
  sceneKey    String?
  scenePackId String?
  name        String?
  isActive    Boolean  @default(true)
  created_at  DateTime @default(now())

  participants Json? // [1,2,3,4]

  // ✅ turno/rodada
  roundNumber    Int   @default(1)
  turnIndex      Int   @default(0) // índice do participante atual na order
  turnOrder      Json? // [ids ordenados por iniciativa]
  actedThisRound Json? // [ids que já agiram nesta rodada]

  room  Room?       @relation(fields: [roomId], references: [id])
  scene Scene?      @relation(fields: [sceneId], references: [id])
  logs  CombatLog[]

  @@map("combat")
}

model CombatLog {
  id         Int      @id @default(autoincrement())
  combatId   Int
  actorId    Int
  targetId   Int?
  action     String
  payload    Json
  created_at DateTime @default(now())

  combat Combat @relation(fields: [combatId], references: [id])

  @@index([combatId])
  @@map("combat_log")
}

model Room {
  id        Int      @id @default(autoincrement())
  name      String?
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  participants RoomParticipant[]
  combats      Combat[]

  @@map("room")
}

model RoomParticipant {
  id          Int      @id @default(autoincrement())
  roomId      Int
  characterId Int
  role        String
  joinedAt    DateTime @default(now())

  room      Room      @relation(fields: [roomId], references: [id])
  character Character @relation(fields: [characterId], references: [id])

  @@unique([roomId, characterId])
  @@index([roomId])
  @@index([characterId])
  @@map("room_participant")
}

model VisualPack {
  id           Int      @id @default(autoincrement())
  packId       String   @unique
  name         String
  version      String
  description  String?
  manifestJson Json
  basePath     String
  isPublic     Boolean  @default(false)
  createdBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  appearances CharacterAppearance[]
  scenes      Scene[]

  @@map("visual_pack")
}

model CharacterAppearance {
  id           Int      @id @default(autoincrement())
  characterId  Int      @unique
  visualPackId Int?
  packId       String?
  skinKey      String   @default("default")
  paletteKey   String?
  scale        Float    @default(1.0)
  offsetX      Int      @default(0)
  offsetY      Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  character  Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)
  visualPack VisualPack? @relation(fields: [visualPackId], references: [id], onDelete: SetNull)

  @@map("character_appearance")
}

model Scene {
  id           Int      @id @default(autoincrement())
  sceneKey     String
  name         String
  visualPackId Int?
  packId       String?
  configJson   Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  visualPack VisualPack? @relation(fields: [visualPackId], references: [id], onDelete: SetNull)
  combats    Combat[]

  @@unique([sceneKey, packId])
  @@map("scene")
}
